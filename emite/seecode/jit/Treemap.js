var Config={tips:false,titleHeight:13,rootId:"infovis",offset:4,levelsToShow:3,Color:{allow:false,minValue:-100,maxValue:100,minColorValue:[255,0,50],maxColorValue:[0,255,50]}};var Layout={orientation:"v",H:"h",V:"v",switchOrientation:function(){this.orientation=(this.orientation=="h")?"v":"h"}};var TreeUtil={prune:function(B,A){this.each(B,function(D,C){if(C==A&&D.children){delete D.children;D.children=[]}})},getSubtree:function(A,D){if(A.id==D){return A}for(var C=0;C<A.children.length;C++){var B=this.getSubtree(A.children[C],D);if(B!=null){return B}}return null},getLeaves:function(A){var C=new Array(),B=new Array();this.each(A,function(E,D){if(D<=Config.levelsToShow&&(!E.children||E.children.length==0)){C.push(E);B.push(Config.levelsToShow-D)}});return{leaves:C,level:B}},resetPath:function(B){var A="#"+Config.rootId+" .in-path";$$(A).each(function(D){D.removeClass("in-path")});var C=(B)?B._parent:false;while(C){C.head.addClass("in-path");C=C._parent}},eachLevel:function(A,F,C,E){if(F<=C){E(A,F);var D=A.children;for(var B=0;B<D.length;B++){this.eachLevel(D[B],F+1,C,E)}}},each:function(A,B){this.eachLevel(A,0,Number.MAX_VALUE,B)},leaf:function(A){return(A.children==0)}};TreeUtil.Group=new Class({initialize:function(B,A){this.array=B;this.objects=new Array();this.controller=A;this.counter=0},loadNodes:function(G,F){this.counter=0;var B=this,A=this.array.length,D=F;var E={};if(this.array.length>0){for(var C=0;C<A;C++){E[this.array[C].id]=this.array[C];this.controller.request(this.array[C].id,G[C],{onComplete:function(K,J){var H=J;for(var I=0;I<H.children.length;I++){H.children[I]._parent=E[K]}E[K].children=H.children;if(++B.counter==A){if(D&&D.onComplete){D.onComplete()}}}})}}else{if(D&&D.onComplete){D.onComplete()}}}});var TM={newHead:function(C,B,A){var E={};E.width=B.offsetWidth-Config.offset;E.left=Config.offset/2;E.height=Config.titleHeight;var D=new Element("div",{"class":"head",html:C.name,styles:{width:E.width,left:E.left}});if(A&&A.onCreateElement){A.onCreateElement(D,C)}return D},newBody:function(B){var A=B.offsetHeight-(Config.titleHeight+Config.offset);var C=B.offsetWidth-Config.offset;var D={top:Config.titleHeight+Config.offset/2,height:A,width:C,left:Config.offset/2};return new Element("div",{"class":"body",styles:D})},newContent:function(A,C){var B={id:A.id,"class":"content",styles:C};return new Element("div",B)},newLeaf:function(E,C,B){var D=(Config.Color.allow)?this.setColor(E):false;var F=C.offsetWidth-Config.offset;var A=C.offsetHeight-Config.offset;var H={top:0,height:A,width:F,left:Config.offset/2};if(D){H["background-color"]=D}var G=new Element("div",{"class":"leaf",styles:H,html:E.name});if(B&&B.onCreateElement){B.onCreateElement(G,E)}return G},setColor:function(D){var E=Config.Color;var A=D.data[1].value.toFloat();var B=function(G,F){return((E.maxColorValue[G]-E.minColorValue[G])/(E.maxValue-E.minValue))*(F-E.minValue)+E.minColorValue[G]};var C=new Array();C[0]=B(0,A).toInt();C[1]=B(1,A).toInt();C[2]=B(2,A).toInt();return C.rgbToHex()},enter:function(B,D){var E=D.getParent().id;var C=this.pre(B,E);var A=TreeUtil.getSubtree(B.tree,E);this.post(B,A,E,C)},out:function(B){var D=B.shownTree._parent;if(D){var A=D;if(B.controller&&B.controller.request){TreeUtil.prune(D,Config.levelsToShow)}var E=D.id;var C=this.pre(B,E);this.post(B,A,E,C)}},pre:function(A,B){if(Config.tips){A.tips.hide()}return postRequest={onComplete:function(){A.loadTree(B);$(Config.rootId).focus();if(A.controller&&A.controller.onAfterCompute){A.controller.onAfterCompute()}}}},post:function(B,A,F,C){if(B.controller&&B.controller.onBeforeCompute){B.controller.onBeforeCompute(A)}if(B.controller&&B.controller.request){var E=TreeUtil.getLeaves(TreeUtil.getSubtree(B.tree,F));var D=new TreeUtil.Group(E.leaves,B.controller);D.loadNodes(E.level,C)}else{setTimeout(function(){C.onComplete()},1)}},initializeBehavior:function(A){var B=$$(".leaf",".head");if(Config.tips){A.tips=new Tips(B,{showDelay:0,hideDelay:0})}B.each(function(C){C.addEvent("mouseenter",function(E){var F=false;if(C.hasClass("leaf")){F=C.getParent().id;C.addClass("over-leaf")}else{if(C.hasClass("head")){F=C.getParent().id;C.addClass("over-head");C.getParent().addClass("over-content")}}if(F){var D=TreeUtil.getSubtree(A.tree,F);TreeUtil.resetPath(D)}E.stopPropagation()});C.addEvent("mouseleave",function(D){if(C.hasClass("over-leaf")){C.removeClass("over-leaf")}else{if(C.getParent().hasClass("over-content")){C.removeClass("over-head");C.getParent().removeClass("over-content")}}TreeUtil.resetPath(false);D.stopPropagation()});C.addEvent("mouseup",function(D){if(D.rightClick){TM.out(A)}else{TM.enter(A,C)}D.preventDefault();return false})})}};TM.SliceAndDice=new Class({initialize:function(A){this.tree=null;this.shownTree=null;this.tips=null;this.controller=A||false},out:function(){TM.out(this)},enter:function(A){TM.enter(this,A)},newContent:function(H,D){var E=(H._parent&&H._parent.body)?H._parent.body:$(Config.rootId);var C=E.offsetWidth;var G=E.offsetHeight;var F=(H._parent&&H._parent.data)?H._parent.data:false;var J=(F&&F.length>0)?H.data[0].value.toFloat()/F[0].value.toFloat():1;if(D==Layout.H){var I=(C*J).round();var B=G}else{var B=(G*J).round();var I=C}var A={width:I,height:B};return TM.newContent(H,A)},loadTree:function(B){$(Config.rootId).empty();var A=TreeUtil.getSubtree(this.tree,B);this.loadFromJSON(A)},loadFromJSON:function(A){var B=(A._parent)?A._parent:false;this.loadTreeFromJSON(false,A,Layout.orientation);A.content.setStyles({top:0,left:0});if(this.tree==null){this.tree=A}this.shownTree=A;A._parent=B;TM.initializeBehavior(this)},loadTreeFromJSON:function(B,M,A){M._parent=B;var C=(B&&B.content)?B.content.getLast():$(Config.rootId);var F=this.newContent(M,A);M.content=F;M.content.inject(C);M.content.oncontextmenu=$lambda(false);if(!TreeUtil.leaf(M)){var J=TM.newHead(M,F,this.controller);var E=TM.newBody(F);E.inject(F);J.inject(F,"top");M.body=E;M.head=J;M.body.oncontextmenu=$lambda(false);M.head.oncontextmenu=$lambda(false)}else{var G=TM.newLeaf(M,F,this.controller);G.inject(F);M.leaf=G;M.leaf.oncontextmenu=$lambda(false)}A=(A==Layout.H)?Layout.V:Layout.H;var D=(A==Layout.H)?"width":"height";var I=(A==Layout.H)?"left":"top";var H=(A==Layout.H)?"top":"left";var O=0;var N=M.content.getStyle(D);var K=M.data[0].value.toFloat();var L=this;M.children.each(function(P){L.loadTreeFromJSON(M,P,A);P.content.setStyle(I,O);P.content.setStyle(H,0);O+=P.content.getStyle(D).toInt()})}});TM.Squarified=new Class({initialize:function(A){this.tree=null;this.shownTree=null;this.tips=null;this.controller=A||false},out:function(){TM.out(this)},enter:function(A){TM.enter(this,A)},loadTree:function(B){$(Config.rootId).empty();var A=TreeUtil.getSubtree(this.tree,B);this.loadFromJSON(A)},loadFromJSON:function(B){var C=(B._parent)?B._parent:false;var A=$(Config.rootId);var D={height:A.offsetHeight,width:A.offsetWidth,top:0,left:0};B.coord=D;this.createBox(A,B,B.coord);this.loadTreeFromJSON(false,B,B.coord);if(this.tree==null){this.tree=B}this.shownTree=B;B._parent=C;TM.initializeBehavior(this)},createBox:function(A,B,C){B.content=TM.newContent(B,C);B.content.oncontextmenu=$lambda(false);B.content.inject(A);if(!TreeUtil.leaf(B)){B.head=TM.newHead(B,B.content,this.controller);B.body=TM.newBody(B.content);B.body.inject(B.content);B.body.oncontextmenu=$lambda(false);B.head.oncontextmenu=$lambda(false);B.head.inject(B.content,"top");B.coord.width=B.body.offsetWidth;B.coord.height=B.body.offsetHeight}else{B.leaf=TM.newLeaf(B,B.content,this.controller);B.leaf.inject(B.content);B.leaf.oncontextmenu=$lambda(false);B.coord.width=B.leaf.offsetWidth;B.coord.height=B.leaf.offsetHeight}},worstAspectRatio:function(C,B){if(!C||C.length==0){return Number.MAX_VALUE}var D=0,A=0,E=Number.MAX_VALUE;(function(G){for(var F=0;F<G.length;F++){var H=G[F]._area;D+=H;E=(E<H)?E:H;A=(A>H)?A:H}})(C);return Math.max(B*B*A/(D*D),D*D/(B*B*E))},loadTreeFromJSON:function(D,B,E){B._parent=D;if(!(E.width>=E.height&&Layout.orientation==Layout.H)){Layout.switchOrientation()}var C=B.children;if(C.length>0){this.processChildrenLayout(B,C,E);for(var A=0;A<C.length;A++){C[A]._parent=B;this.createBox(B.body,C[A],C[A].coord)}for(var A=0;A<C.length;A++){C[A].coord.left=0;C[A].coord.top=0;if(TreeUtil.leaf(C[A])){C[A].coord.width=C[A].leaf.offsetWidth;C[A].coord.height=C[A].leaf.offsetHeight}else{C[A].coord.width=C[A].body.offsetWidth;C[A].coord.height=C[A].body.offsetHeight}this.loadTreeFromJSON(B,C[A],C[A].coord)}}},processChildrenLayout:function(D,C,F){(function(K,J){var G=K.body.offsetWidth*K.body.offsetHeight;var I=K.data[0].value.toFloat();for(var H=0;H<J.length;H++){J[H]._area=G*J[H].data[0].value.toFloat()/I}})(D,C);var A=(Layout.orientation==Layout.H)?F.height:F.width;C.sort(function(H,G){if(H._area<G._area){return 1}if(H._area==G.area){return 0}return -1});var E=[C[0]];var B=C.slice(1);this.squarify(B,E,A,F)},squarify:function(B,F,A,E){if(B.length+F.length==1){if(B.length==1){this.layoutLast(B,A,E)}else{this.layoutLast(F,A,E)}return }if(B.length>=2&&F.length==0){F=[B[0]];B=B.slice(1)}if(B.length==0){if(F.length>0){this.layoutRow(F,A,E)}return }var D=B[0];if(this.worstAspectRatio(F,A)>=this.worstAspectRatio([D].concat(F),A)){this.squarify(B.slice(1),F.concat([D]),A,E)}else{var C=this.layoutRow(F,A,E);this.squarify(B,[],C.minimumSideValue,C)}},layoutLast:function(B,A,C){B[0].coord=C},layoutRow:function(A,I,F){var K=(function(N){for(var M=0,O=0;M<N.length;M++){O+=N[M]._area}return O})(A);var D=(Layout.orientation==Layout.H)?"height":"width";var C=(Layout.orientation==Layout.H)?"width":"height";var H=(K/I).round();var G=(Layout.orientation==Layout.V)?F.height-H:0;var B=0;for(var E=0;E<A.length;E++){var L={};L[D]=(A[E]._area/H).round();L[C]=H;L.top=(Layout.orientation==Layout.H)?F.top+(I-L[D]-G):G;L.left=(Layout.orientation==Layout.H)?F.left:F.left+B;A[E].coord=L;if(Layout.orientation==Layout.H){G+=L[D]}else{B+=L[D]}}var J={};J[C]=F[C]-H;J[D]=F[D];J.left=(Layout.orientation==Layout.H)?F.left+H:F.left;J.top=F.top;J.minimumSideValue=(J[C]>J[D])?J[D]:J[C];if(J.minimumSideValue!=J[D]){Layout.switchOrientation()}return J}});