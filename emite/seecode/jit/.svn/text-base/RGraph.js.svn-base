var Canvas=function(B,A,C){this.canvasId=B;this.fillStyle=A;this.strokeStyle=C;if((this.canvas=document.getElementById(this.canvasId))&&this.canvas.getContext){this.ctx=this.canvas.getContext("2d");this.ctx.fillStyle=A||"black";this.ctx.strokeStyle=C||"white";this.setPosition();this.translateToCenter()}else{throw"Canvas object could not initialize."}};Canvas.prototype={getContext:function(){return this.ctx},setPosition:function(){var A=this.canvas;var B=curtop=0;if(A.offsetParent){B=A.offsetLeft;curtop=A.offsetTop;while(A=A.offsetParent){B+=A.offsetLeft;curtop+=A.offsetTop}}this.position={x:B,y:curtop}},getPosition:function(){return this.position},clear:function(){this.ctx.clearRect(-this.getSize().x/2,-this.getSize().x/2,this.getSize().x,this.getSize().x)},drawConcentricCircles:function(B){var C=B||6;var D=this.ctx;D.strokeStyle=Config.concentricCirclesColor;for(var A=1;A<=C;A++){D.beginPath();D.arc(0,0,(A*Config.levelDistance),0,Math.PI*2,true);D.stroke();D.closePath()}D.strokeStyle=this.strokeStyle},translateToCenter:function(){this.ctx.translate(this.canvas.width/2,this.canvas.height/2)},getSize:function(){var B=this.canvas.width;var A=this.canvas.height;return{x:B,y:A}},path:function(A,B){this.ctx.beginPath();B(this.ctx);this.ctx[A]();this.ctx.closePath()}};var Complex=function(){if(arguments.length>1){this.x=arguments[0];this.y=arguments[1]}else{this.x=null;this.y=null}};Complex.prototype={toPolar:function(){var A=this.norm();var B=Math.atan2(this.y,this.x);if(B<0){B+=Math.PI*2}return new Polar(B,A)},norm:function(){return Math.sqrt(this.squaredNorm())},squaredNorm:function(){return this.x*this.x+this.y*this.y},add:function(A){return new Complex(this.x+A.x,this.y+A.y)},prod:function(A){return new Complex(this.x*A.x-this.y*A.y,this.y*A.x+this.x*A.y)},conjugate:function(){return new Complex(this.x,-this.y)},scale:function(A){return new Complex(this.x*A,this.y*A)},toString:function(){return"{x:"+this.x+" y:"+this.y+"}"}};var Polar=function(B,A){this.theta=B;this.rho=A};Polar.prototype={toComplex:function(){return new Complex(Math.cos(this.theta),Math.sin(this.theta)).scale(this.rho)},add:function(A){return new Polar(this.theta+A.theta,this.rho+A.rho)},scale:function(A){return new Polar(this.theta,this.rho*A)}};var Config={labelContainer:"label_container",drawConcentricCircles:true,concentricCirclesColor:"#444",levelDistance:100,normalizeDiameters:false,nodeRangeDiameters:{min:10,max:50},nodeRangeValues:{min:1,max:11},fps:25,animationTime:2000};var GraphUtil={eachNode:function(C,B){for(var A in C.nodes){B(C.nodes[A])}},getNode:function(A,B){return A.nodes[B]},eachAdjacency:function(D,B,C){for(var A=0,E=B.adjacencies;A<E.length;A++){C(this.getNode(D,E[A]))}},eachBFS:function(I,A,D){var H=this;this.eachNode(I,function(J){J._flag=false});var F=[this.getNode(I,A)];while(F.length!=0){var C=F.pop();C._flag=true;D(C,C._depth);for(var E=0,G=C.adjacencies;E<G.length;E++){var B=this.getNode(I,G[E]);if(B._flag==false){B._depth=C._depth+1;F.unshift(B)}}}},eachSubnode:function(E,C,D){var F=C._depth;for(var A=0,B=C.adjacencies;A<B.length;A++){var G=this.getNode(E,B[A]);if(G._depth>F){D(G)}}},getParents:function(E,D){var B=D.adjacencies;var A=new Array();for(var C=0;C<B.length;C++){var F=this.getNode(E,B[C]);if(F._depth<D._depth){A.push(F)}}return A}};var GraphPlot={labels:new Array(),labelsHidden:false,hideLabels:function(B){var A=document.getElementById(Config.labelContainer);if(B){A.style.display="none"}else{A.style.display=""}this.labelsHidden=B},animate:function(G,H,E,B){var A=this;this.hideLabels(true);var C=function(K,J,I){return(J.add(K.scale(-1))).scale(I).add(K).toPolar()};var D=function(I,L){var K=I.startPos.toComplex();var J=I.endPos.toComplex();I.pos=C(K,J,L)};var F={compute:function(I){E.clear();if(Config.drawConcentricCircles){E.drawConcentricCircles()}GraphUtil.eachBFS(G,H,function(J){if(J._root){D(J,I)}A.plotNode(J,E);if(!this.labelsHidden){A.plotLabel(E,J,5,J._root)}GraphUtil.eachSubnode(G,J,function(K){D(K,I);A.plotLine(J,K,E)})})},complete:function(){A.hideLabels(false);GraphUtil.eachNode(G,function(I){I.startPos=I.pos});A.plot(G,H,E,false,B);if(B&&B.onAfterCompute){B.onAfterCompute()}}};var A=this;Animation.controller=F;Animation.start()},plot:function(E,G,C,B,F){var D=E;var A=this;C.clear();if(Config.drawConcentricCircles){C.drawConcentricCircles()}GraphUtil.eachBFS(E,G,function(I,H){A.plotNode(I,C);if(!this.labelsHidden){A.plotLabel(C,I,5,I._root,B,F)}GraphUtil.eachSubnode(D,I,function(J){A.plotLine(I,J,C)})})},plotNode:function(B,A){var C=B.pos.toComplex();A.path("fill",function(D){D.arc(C.x,C.y,4,0,Math.PI*2,true)})},plotLine:function(B,E,A){var D=B.pos.toComplex();var C=E.pos.toComplex();A.path("stroke",function(F){F.moveTo(D.x,D.y);F.lineTo(C.x,C.y)})},plotLabel:function(C,E,K,I,J,F){var B=E.id;var L=false;if(!(L=document.getElementById(B))){L=document.createElement("div");var A=document.getElementById(Config.labelContainer);A.appendChild(L);if(F&&F.onCreateLabel){F.onCreateLabel(L,E)}if(J&&J.onClick){L.onclick=function(){J.onClick(B)}}}var H=E.pos.toComplex();var G=C.getSize();var D={x:Math.round(H.x+C.getPosition().x+G.x/2-K/2),y:Math.round(H.y+C.getPosition().y+G.y/2-K/2)};L.id=B;L.className="node";L.style.position="absolute";L.style.width=K+"px";L.style.height=K+"px";L.style.left=D.x+"px";L.style.top=D.y+"px";if(this.fitsInCanvas(D,C)){L.style.display=""}else{L.style.display="none"}if(F&&F.onPlaceLabel){F.onPlaceLabel(L,E)}},fitsInCanvas:function(C,A){var B=A.getSize();if(C.x>=B.x+A.position.x||C.x<A.position.x||C.y>=B.y+A.position.y||C.y<A.position.y){return false}return true}};var RGraph=function(B,A){this.controller=A||false;this.graph=new Graph();this.json=null;this.canvas=B;this.root=null};RGraph.prototype={loadTree:function(B){var C=B.children;for(var A=0;A<C.length;A++){this.graph.addAdjacence(B,C[A]);this.loadTree(C[A])}},flagRoot:function(A){this.unflagRoot();this.graph.nodes[A]._root=true},unflagRoot:function(){GraphUtil.eachNode(this.graph,function(A){A._root=false})},getRoot:function(){var A=false;GraphUtil.eachNode(this.graph,function(B){if(B._root){A=B}});return A},loadTreeFromJSON:function(A){this.json=A;this.loadTree(A);this.root=A.id},plot:function(){GraphPlot.plot(this.graph,this.root,this.canvas,this,this.controller)},compute:function(B){var C=B||["pos","startPos"];var A=GraphUtil.getNode(this.graph,this.root);A._depth=0;this.flagRoot(this.root);this.computeAngularWidths();this.computePositions(C)},computePositions:function(E){var B=(typeof E=="array"||typeof E=="object")?E:[E];var D=this.graph;var A=GraphUtil.getNode(this.graph,this.root);for(var C=0;C<B.length;C++){A[B[C]]=new Polar(0,0)}A.angleSpan={begin:0,end:2*Math.PI};GraphUtil.eachBFS(this.graph,this.root,function(I){var G=I.angleSpan.end-I.angleSpan.begin;var F=(I._depth+1)*Config.levelDistance;var J=I.angleSpan.begin;var H=(function(K){var L=0;GraphUtil.eachSubnode(D,K,function(M){L+=M._treeAngularWidth});return L})(I);GraphUtil.eachSubnode(D,I,function(N){var M=N._treeAngularWidth/H*G;var L=J+M/2;for(var K=0;K<B.length;K++){N[B[K]]=new Polar(L,F)}N.angleSpan={begin:J,end:J+M};J+=M})})},setAngularWidthForNodes:function(){var C=Config.nodeRangeValues,A=Config.nodeRangeDiameters;var B=function(D){return(((A.max-A.min)/(C.max-C.min))*(D-C.min)+A.min)};GraphUtil.eachBFS(this.graph,this.root,function(G,E){var H=(Config.normalizeDiameters&&G.data&&G.data.length>0)?G.data[0].value:C.min;var F=B(H);var D=Config.levelDistance*E;G._angularWidth=F/D})},setSubtreesAngularWidth:function(){var A=this;GraphUtil.eachNode(this.graph,function(B){A.setSubtreeAngularWidth(B)})},setSubtreeAngularWidth:function(D){var B=this,C=D._angularWidth,A=0;GraphUtil.eachSubnode(this.graph,D,function(E){B.setSubtreeAngularWidth(E);A+=E._treeAngularWidth});D._treeAngularWidth=Math.max(C,A)},computeAngularWidths:function(){this.setAngularWidthForNodes();this.setSubtreesAngularWidth()},getNodeAndParentAngle:function(H){var C=false;var G=GraphUtil.getNode(this.graph,H);var E=GraphUtil.getParents(this.graph,G);var D=(E.length>0)?E[0]:false;if(D){var A=D.pos.toComplex(),F=G.pos.toComplex();var B=A.add(F.scale(-1));C=(function(J){var I=Math.atan2(J.y,J.x);if(I<0){I=2*Math.PI+I}return I})(B)}return{_parent:D,theta:C}},onClick:function(C){if(this.root!=C){var B=this.getNodeAndParentAngle(C);this.root=C;if(this.controller&&this.controller.onBeforeCompute){this.controller.onBeforeCompute(GraphUtil.getNode(this.graph,C))}this.compute("endPos");var A=B.theta-B._parent.endPos.theta;GraphUtil.eachNode(this.graph,function(D){D.endPos=D.endPos.add(new Polar(A,0))});GraphPlot.animate(this.graph,C,this.canvas,this.controller)}}};var Graph=function(){this.nodes={}};Graph.prototype={addAdjacence:function(C,B){if(!this.hasNode(C.id)){this.addNode(C)}if(!this.hasNode(B.id)){this.addNode(B)}for(var A in this.nodes){if(this.nodes[A].id==C.id){if(!this.nodes[A].adjacentTo(B.id)){this.nodes[A].addAdjacency(B.id)}}if(this.nodes[A].id==B.id){if(!this.nodes[A].adjacentTo(C.id)){this.nodes[A].addAdjacency(C.id)}}}},addNode:function(B){if(!this.nodes[B.id]){var A=new Graph.Node(B.id,B.name,B.data);this.nodes[B.id]=A}},hasNode:function(B){for(var A in this.nodes){if(A==B){return true}}return false}};Graph.Node=function(C,A,B){this.id=C;this.name=A;this.data=B;this.drawn=false;this.angleSpan={begin:0,end:0};this.pos=new Polar(0,0);this.startPos=new Polar(0,0);this.endPos=new Polar(0,0);this.adjacencies=new Array()};Graph.Node.prototype={adjacentTo:function(B){for(var A=0;A<this.adjacencies.length;A++){if(B==this.adjacencies[A]){return true}}return false},addAdjacency:function(A){this.adjacencies.push(A)}};var Trans={linear:function(A){return A},Quart:function(A){return Math.pow(A,4)},easeIn:function(A,B){return A(B)},easeOut:function(A,B){return 1-A(1-B)},easeInOut:function(A,B){return(B<=0.5)?A(2*B)/2:(2-A(2*(1-B)))/2}};var Animation={duration:Config.animationTime,fps:Config.fps,transition:function(A){return Trans.easeInOut(Trans.Quart,A)},controller:false,getTime:function(){var A=(Date.now)?Date.now():new Date().getTime();return A},step:function(){var A=this.getTime();if(A<this.time+this.duration){var B=this.transition((A-this.time)/this.duration);this.controller.compute(B)}else{this.timer=clearInterval(this.timer);this.controller.compute(1);this.controller.complete()}},start:function(){this.time=0;this.startTimer();return this},stopTimer:function(){if(!this.timer){return false}this.time=$time()-this.time;this.timer=$clear(this.timer);return true},startTimer:function(){if(this.timer){return false}this.time=this.getTime()-this.time;this.timer=setInterval((function(){Animation.step()}),Math.round(1000/this.fps));return true}};